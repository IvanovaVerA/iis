## О чем проект

Проект посвящен решению задачи предсказания классификации цен на мобильные устройства. Ссылка на исходную выборку данных: https://www.kaggle.com/datasets/iabhishekofficial/mobile-price-classification?resource=download

## Запуск

Для запуска проекта необходимо выполнить команды:
```
git clone git@github.com:IvanovaVerA/iis.git
```
или:
```
git clone https://github.com/IvanovaVerA/iis.git
```
переход в папку:
```
cd IIS
```
установка окружения:
```
python -m venv .venv -
```
активация окружения:
```
source .venv/bin/activate
```
установка зависимостей:
```
python -m pip install -r requirements.txt 
```

## Исследование данных

Находится в ./eda/eda.ipynb. Основные результаты:

В ходе исследования были проведены действия:

   - Удалены записи с нулевыми значениями для признаков battery_power, clock_speed, int_memory, m_dep

   - Установлены минимальные значения для размера мобильного устройства: mobile_wt, px_height, px_width

   - Удалены строки, у которых ширина (sc_w) больше высоты (sc_h)



В ходе анализа были выявлены следующие закономерности:

   - Наибольшая корреляция с целевой переменной (price_range) наблюдается у ram (0.92) (см. графики ./eda/CorrelationHeatmap.png и ./eda/ram_vs_price.png)

   - Так же значимыми признаками являются px_height и px_width и была создана новая переменная total_pixels = px_height * px_width (см. график ./eda/new_features.png)

   - имеется положительная линейная зависимость между вуысотой и шириной экрана мобильного устройства

   # Проведение экспериментов по настройке модели.
## Запуск MLFlow

Перейти в директорию mlflow и выполнить скрипт для запуска сервера:

```
cd mlflow
```

```
./run_mlflow.sh
```

## Исследования

Сравнивали между собой модели:

1) Baseline-модель
2) Модель с новыми признаками, полученными с использованием библиотеки sklearn.
3) Модель с наиболее важными признаками, полученными с использованием библиотеки mlxtend.

Для лучшей модели подбирались гиперпараметры с помощью GridSearchCV.

## Результаты исследования

Лучшeй оказалась модель main_features (с отбором наиболее важных признаков) со следующими метриками:

 * recall - 0.9090909090909091
 * precision - 0.9102642811116279
 * f1 - 0.9092405620419367


Лучшиe гиперпараметры:
 * max_depth=None
 * max_features=0.1
 * n_estimators=50

Метрики для данной модели с подобранными гиперпараметрами стали ниже:
* recall - 0.7892561983471075
* precision - 0.7885240640408138
* f1 - 0.7883848892194888

run_id Production модели:
```
01fd4e9e356646e78822ebac40d37d61
```

# Создание сервиса предсказаний

## Основной API-сервер с FastAPI

 - Cделать обработку GET-запросов к корню приложения /, выдавая в ответ на запрос словарь {"Hello": "World"}

 - Endpoint /api/prediction выдачи предсказания для объекта  обрабатывает POST-запросы, принимая в качестве URL-параметра идентификатор объекта item_id, а в теле запроса (body) все признаки объекта, необходимые для подачи на вход модели и выдачи предсказания. Возвращаeт словарь из двух объектов - item_id - тот же идентификатор объекта, и predict - предсказанное значение.

## Обработчик предсказаний модели

 - При создании экземпляра класса загружает модель из файла model.pkl

 - Метод predict принимает словарь с признаками объекта, преобразует его в pandas.DataFrame, подает на вход модели и возвращает предсказание.

## Контейнеризация

Для работы с MLflow локально. Он выполняет загрузку модели из хранилища MLflow Tracking Server и сохраняет ее в файл model.pkl для дальнейшего использования.

Создание образа:
```
docker build . --tag device_model:1
```

Запуск контейнера:
```
docker run --rm -p 8001:8000 -v $(pwd)/../models:/models device_model:1
```

## Проверка работоспособности сервиса

Пример тестового запроса:

```
{
    "battery_power": 1434,
    "blue": 0,
    "clock_speed": 1.4,
    "dual_sim": 0,
    "fc": 11,
    "four_g": 1,
    "int_memory": 49,
    "m_dep": 0.5,
    "mobile_wt": 108,
    "n_cores": 6,
    "pc": 18,
    "px_height": 749,
    "px_width": 810,
    "ram": 1773,
    "sc_h": 15,
    "sc_w": 8,
    "talk_time": 7,
    "three_g": 1,
    "touch_screen": 0,
    "wifi": 1,
    "screen_size": 17,
    "total_pixels": 1799140
}
```

Ожидаемый ответ:

```
{
  "price": "1",
  "item_id": 123
}
```

# Мониторинг

## Prometheus

 - Веб-интерфейс доступен по адресу: http://localhost:9090
 - Конфигурационный файл: /services/prometheus/prometheus.yml
 - Полученные скриншоты и файл конфигурации размещены в директории: /services/prometheus

## Дашборд (Grafana)

 - Создан дашборд для мониторинга метрик, который сохранён в директории: /services/grafana.
 - Веб-интерфейс Grafana доступен по адресу: http://localhost:3000.
 - В качестве источника данных (database) используется сервис Prometheus.

![](/services/grafana/dashboard.jpg)

### Графики дашборда:

**График 1** - Total Predictions

 - Отслеживание объема работы ML-модели
 - Качество ML-модели


**График 2** - Memory

 - Мониторинг виртуальной и резидентной памяти, занимаемой сервисом
 - Инфраструктурный уровень

**График 3** - CPU Time rate

 - Мониторинг процессорного времени, занимаемого сервисом
 - Инфраструктурный уровень

**График 4** - RPS

 - Частота HTTP-запросов с группировкой по эндпоинтам, типам запроса и статусам ответа
 - Прикладной уровень

 **График 5** 

 - Распределение значений предсказаний по диапазонам
 - Качество ML-модели